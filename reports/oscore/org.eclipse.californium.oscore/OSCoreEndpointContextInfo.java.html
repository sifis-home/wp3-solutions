<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OSCoreEndpointContextInfo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cf-OSCORE</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.californium.oscore</a> &gt; <span class="el_source">OSCoreEndpointContextInfo.java</span></div><h1>OSCoreEndpointContextInfo.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2019 RISE SICS and others.
 * 
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * and Eclipse Distribution License v1.0 which accompany this distribution.
 * 
 * The Eclipse Public License is available at
 *    http://www.eclipse.org/legal/epl-v20.html
 * and the Eclipse Distribution License is available at
 *    http://www.eclipse.org/org/documents/edl-v10.html.
 * 
 * Contributors:
 *    Rikard HÃ¶glund (RISE SICS)
 *    
 ******************************************************************************/
package org.eclipse.californium.oscore;

import org.eclipse.californium.core.coap.Message;
import org.eclipse.californium.core.coap.Request;
import org.eclipse.californium.core.coap.Response;
import org.eclipse.californium.core.network.Exchange;
import org.eclipse.californium.core.network.Exchange.EndpointContextOperator;
import org.eclipse.californium.elements.Definition;
import org.eclipse.californium.elements.EndpointContext;
import org.eclipse.californium.elements.MapBasedEndpointContext;
import org.eclipse.californium.elements.MapBasedEndpointContext.Attributes;

/**
 * Class that handles setting information in an EndpointContext for OSCORE
 * messages.
 *
 * It provides functionality to set appropriate information about the OSCORE
 * context used, as strings in the map inside an EndpointContext.
 *
 * When an application is receiving a message or sending a request it can use
 * the strings in the EndpointContext to retrieve information about what OSCORE
 * context was used for this messages.
 *
 * Information that can be retrieved is the URI associated to the OSCORE
 * context, the Sender ID, Recipient ID and Context ID of the OSCORE context.
 *
 * This class contains methods to set the source endpoint context for incoming
 * messages. It also contains a method that adds an operator on the exchange
 * when sending a request that will make the new created destination endpoint
 * context available via a callback. For outgoing responses the destination
 * endpoint context used will be the source endpoint context created for the
 * incoming request.
 */
<span class="nc" id="L50">public class OSCoreEndpointContextInfo {</span>

	/**
	 * Defines strings for the keys to be set in the EndpointContext.
	 */

	private final static String PREFIX = MapBasedEndpointContext.KEY_PREFIX_NONE_CRITICAL;

<span class="fc" id="L58">	public final static Definition&lt;String&gt; OSCORE_SENDER_ID = new Definition&lt;&gt;(PREFIX + &quot;OSCORE_SENDER_ID&quot;, String.class,</span>
			MapBasedEndpointContext.ATTRIBUTE_DEFINITIONS);

<span class="fc" id="L61">	public final static Definition&lt;String&gt; OSCORE_RECIPIENT_ID = new Definition&lt;&gt;(PREFIX + &quot;OSCORE_RECIPIENT_ID&quot;, String.class,</span>
			MapBasedEndpointContext.ATTRIBUTE_DEFINITIONS);

<span class="fc" id="L64">	public final static Definition&lt;String&gt; OSCORE_CONTEXT_ID = new Definition&lt;&gt;(PREFIX + &quot;OSCORE_CONTEXT_ID&quot;, String.class,</span>
			MapBasedEndpointContext.ATTRIBUTE_DEFINITIONS);

<span class="fc" id="L67">	public final static Definition&lt;String&gt; OSCORE_URI = new Definition&lt;&gt;(PREFIX + &quot;OSCORE_URI&quot;, String.class,</span>
			MapBasedEndpointContext.ATTRIBUTE_DEFINITIONS);

	/**
	 * Sets information in a destination endpoint context for outgoing requests.
	 *
	 * Sending a request is a special case since an operator should be added to
	 * the exchange that sets the appropriate information in the endpoint
	 * context that will be created after the request is sent.
	 *
	 * @param oscoreCtx the OSCORE context used for this message
	 * @param exchange the exchange to later set the endpoint context for
	 */
	public static void sendingRequest(OSCoreCtx oscoreCtx, Exchange exchange) {
<span class="fc" id="L81">		exchange.setEndpointContextPreOperator(new OSCoreEndpointContextOperator(oscoreCtx));</span>
<span class="fc" id="L82">	}</span>

	/**
	 * Class that functions as an operator on the exchange. It will set
	 * information about the OSCORE context used on the new endpoint context
	 * created after the request is sent.
	 *
	 * This new endpoint context is available using
	 * MessageObserver.onContextEstablished(EndpointContext).
	 *
	 */
	private static class OSCoreEndpointContextOperator implements EndpointContextOperator {

		/**
		 * OSCORE context to take information from to set in the endpoint
		 * context
		 */
		private final OSCoreCtx oscoreCtx;

		/**
		 * Constructor taking an OSCORE Context that the information to be set
		 * in the endpoint context will be taken from.
		 *
		 * @param oscoreCtx the OSCORE context to take information to set from
		 */
<span class="fc" id="L107">		public OSCoreEndpointContextOperator(final OSCoreCtx oscoreCtx) {</span>
<span class="fc" id="L108">			this.oscoreCtx = oscoreCtx;</span>
<span class="fc" id="L109">		}</span>

		/**
		 * Method that will be ran when setting the endpoint context for an
		 * exchange. Should perform changes to the endpoint context to add the
		 * OSCORE-related strings.
		 *
		 * @return the new endpoint context to use
		 */
		@Override
		public EndpointContext apply(EndpointContext context) {
<span class="fc" id="L120">			return setInfo(oscoreCtx, context);</span>
		}

	}

	/**
	 * Sets information in a source endpoint context for incoming requests.
	 *
	 * @param oscoreCtx the OSCORE context used for this message
	 * @param request the request to set the endpoint context for
	 */
	public static void receivingRequest(OSCoreCtx oscoreCtx, Request request) {
<span class="fc" id="L132">		setInfoIncoming(oscoreCtx, request);</span>
<span class="fc" id="L133">	}</span>

	/**
	 * Sets information in a source endpoint context for incoming responses.
	 *
	 * @param oscoreCtx the OSCORE context used for this message
	 * @param response the response to set the endpoint context for
	 */
	public static void receivingResponse(OSCoreCtx oscoreCtx, Response response) {
<span class="fc" id="L142">		setInfoIncoming(oscoreCtx, response);</span>
<span class="fc" id="L143">	}</span>

	/**
	 * Adds strings with information about the OSCORE context used to this
	 * source endpoint context for incoming messages.
	 *
	 * @param oscoreCtx the OSCORE context used for this message
	 * @param message the message to set information in the source endpoint
	 *            context for
	 */
	private static void setInfoIncoming(OSCoreCtx oscoreCtx, Message message) {

		// Create new MapBasedEndpointContext for source endpoint context with
		// string values for OSCORE added
<span class="fc" id="L157">		EndpointContext newEndpointContext = setInfo(oscoreCtx, message.getSourceContext());</span>
<span class="fc" id="L158">		message.setSourceContext(newEndpointContext);</span>
<span class="fc" id="L159">	}</span>

	/**
	 * Adds strings with information about the OSCORE context used to this
	 * endpoint context (creating a new one).
	 *
	 * @param oscoreCtx the OSCORE context used
	 * @param endpointContext the original endpoint context to set information
	 *            based on
	 *
	 * @return the new endpoint context
	 */
	private static MapBasedEndpointContext setInfo(OSCoreCtx oscoreCtx, EndpointContext endpointContext) {

		// If endpoint context is not set, keep it unset
<span class="fc bfc" id="L174" title="All 2 branches covered.">		if (endpointContext == null) {</span>
<span class="fc" id="L175">			return null;</span>
		}

		// Create new MapBasedEndpointContext for this endpoint context with
		// string values for OSCORE added
<span class="fc" id="L180">		Attributes attributes = new Attributes();</span>
<span class="fc" id="L181">		attributes.add(OSCORE_SENDER_ID, oscoreCtx.getSenderIdString());</span>
<span class="fc" id="L182">		attributes.add(OSCORE_RECIPIENT_ID, oscoreCtx.getRecipientIdString());</span>
<span class="fc" id="L183">		attributes.add(OSCORE_CONTEXT_ID, oscoreCtx.getContextIdString());</span>
<span class="fc" id="L184">		attributes.add(OSCORE_URI, oscoreCtx.getUri());</span>
<span class="fc" id="L185">		MapBasedEndpointContext newEndpointContext = MapBasedEndpointContext.addEntries(endpointContext, attributes);</span>

<span class="fc" id="L187">		return newEndpointContext;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>