<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EdhocResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Cf-EDHOC</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.californium.edhoc</a> &gt; <span class="el_source">EdhocResource.java</span></div><h1>EdhocResource.java</h1><pre class="source lang-java linenums">/*******************************************************************************
 * Copyright (c) 2020 RISE and others.
 * 
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * and Eclipse Distribution License v1.0 which accompany this distribution.
 * 
 * The Eclipse Public License is available at
 *    http://www.eclipse.org/legal/epl-v20.html
 * and the Eclipse Distribution License is available at
 *    http://www.eclipse.org/org/documents/edl-v10.html.
 *
 * This class is based on org.eclipse.californium.examples.HelloWorldServer
 * 
 * Contributors:
 *    Marco Tiloca (RISE)
 *    Rikard HÃ¶glund (RISE)
 *    
 ******************************************************************************/
package org.eclipse.californium.edhoc;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Set;

import org.eclipse.californium.core.CoapResource;
import org.eclipse.californium.core.Utils;
import org.eclipse.californium.core.coap.Response;
import org.eclipse.californium.core.coap.CoAP.ResponseCode;
import org.eclipse.californium.core.server.resources.CoapExchange;
import org.eclipse.californium.cose.AlgorithmID;
import org.eclipse.californium.oscore.OSCoreCtx;
import org.eclipse.californium.oscore.OSException;

import com.upokecenter.cbor.CBORObject;
import com.upokecenter.cbor.CBORType;

/*
 * Definition of the EDHOC Resource
 */
public class EdhocResource extends CoapResource {

	private EdhocEndpointInfo edhocEndpointInfo;
	private Set&lt;CBORObject&gt; ownIdCreds;
	
	private static final boolean debugPrint = true;
	
	public EdhocResource(String resourceIdentifier, EdhocEndpointInfo edhocEndpointInfo, Set&lt;CBORObject&gt; ownIdCreds) {
		
		// set resource identifier
<span class="nc" id="L52">		super(resourceIdentifier);</span>

		// set the information about the EDHOC server hosting this EDHOC resource
<span class="nc" id="L55">		this.edhocEndpointInfo = edhocEndpointInfo;</span>
		
		// set the collection of ID_CRED_X used for an authentication credential associated to this peer
<span class="nc" id="L58">		this.ownIdCreds = ownIdCreds;</span>
		
		// set display name
<span class="nc" id="L61">		getAttributes().setTitle(&quot;EDHOC Resource&quot;);</span>
<span class="nc" id="L62">	}</span>

	@Override
	public void handleGET(CoapExchange exchange) {

		// respond to the request
<span class="nc" id="L68">		exchange.respond(&quot;Send me a POST request to run EDHOC!&quot;);</span>
<span class="nc" id="L69">	}</span>
	
	
	@Override
	public void handlePOST(CoapExchange exchange) {
		
<span class="nc" id="L75">		byte[] nextMessage = new byte[] {};</span>
				
		// Retrieve the application profile to use
<span class="nc" id="L78">		AppProfile appProfile = edhocEndpointInfo.getAppProfiles().get(exchange.advanced().getRequest().getURI());</span>
		
		// Error when retrieving the application profile for this EDHOC resource
<span class="nc bnc" id="L81" title="All 2 branches missed.">		if (appProfile == null) {</span>
<span class="nc" id="L82">			String responseString = new String(&quot;Error when retrieving the application profile&quot;);</span>
<span class="nc" id="L83">			System.err.println(responseString);</span>
			
<span class="nc" id="L85">			nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L86">			Response genericErrorResponse = new Response(ResponseCode.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L87">			genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L88">			exchange.respond(genericErrorResponse);</span>
<span class="nc" id="L89">			return;</span>
			
		}
		
<span class="nc" id="L93">		byte[] message = exchange.getRequestPayload();</span>
		
<span class="nc" id="L95">		boolean hasContentFormat = exchange.getRequestOptions().hasContentFormat();</span>
<span class="nc" id="L96">		int contentFormat = exchange.getRequestOptions().getContentFormat();</span>
		
<span class="nc bnc" id="L98" title="All 12 branches missed.">		if ( (message == null &amp;&amp; !hasContentFormat) ||</span>
			 (message != null &amp;&amp; hasContentFormat &amp;&amp; contentFormat != Constants.APPLICATION_CID_EDHOC_CBOR_SEQ &amp;&amp;
			  contentFormat != Constants.APPLICATION_EDHOC_CBOR_SEQ) ) {
			// The server can start acting as Initiator and send an EDHOC Message 1 as a CoAP response
<span class="nc" id="L102">			processTriggerRequest(exchange, appProfile);</span>
<span class="nc" id="L103">			return;</span>
		}
		
<span class="nc bnc" id="L106" title="All 8 branches missed.">		if ( message == null ||</span>
			(message != null &amp;&amp; hasContentFormat &amp;&amp; contentFormat != Constants.APPLICATION_CID_EDHOC_CBOR_SEQ) ) {
<span class="nc" id="L108">			String responseString = new String(&quot;Error when receiving a request to the EDHOC resource&quot;</span>
					+ &quot;An EDHOC message must be included in a request either without content-format &quot;
					+ &quot;or with content-format application/cid-edhoc+cbor-seq&quot;);
<span class="nc" id="L111">			System.err.println(responseString);</span>
			
<span class="nc" id="L113">			nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L114">			Response genericErrorResponse = new Response(ResponseCode.BAD_REQUEST);</span>
<span class="nc" id="L115">			genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L116">			exchange.respond(genericErrorResponse);</span>
<span class="nc" id="L117">			return;</span>
		}

<span class="nc" id="L120">		int messageType = MessageProcessor.messageType(message, true, edhocEndpointInfo.getEdhocSessions(), null);</span>
		
		// Invalid EDHOC message type
<span class="nc bnc" id="L123" title="All 2 branches missed.">		if (messageType == -1) {</span>
<span class="nc" id="L124">			String responseString = new String(&quot;Invalid EDHOC message type&quot;);</span>
<span class="nc" id="L125">			System.err.println(responseString);</span>
			
<span class="nc" id="L127">			nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L128">			Response genericErrorResponse = new Response(ResponseCode.BAD_REQUEST);</span>
<span class="nc" id="L129">			genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L130">			exchange.respond(genericErrorResponse);</span>
<span class="nc" id="L131">			return;</span>
			
		}
		
<span class="nc" id="L135">		List&lt;CBORObject&gt; processingResult = new ArrayList&lt;CBORObject&gt;();</span>
		
		// Possibly specify external authorization data for EAD_2, or null if none has to be provided
		// The EAD is structured in pairs of CBOR items (int, any), i.e. the data type first and then the actual data
<span class="nc" id="L139">		CBORObject[] ead2 = null;		</span>
		
		// The received message is an actual EDHOC message
		
<span class="nc" id="L143">		String typeName = &quot;&quot;;</span>
<span class="nc bnc" id="L144" title="All 3 branches missed.">		switch (messageType) {</span>
			case Constants.EDHOC_ERROR_MESSAGE:
<span class="nc" id="L146">				typeName = new String(&quot;EDHOC Error Message&quot;);</span>
<span class="nc" id="L147">				break;</span>
			case Constants.EDHOC_MESSAGE_1:
			case Constants.EDHOC_MESSAGE_2:
			case Constants.EDHOC_MESSAGE_3:
			case Constants.EDHOC_MESSAGE_4:
<span class="nc" id="L152">				typeName = new String(&quot;EDHOC Message &quot; + messageType);</span>
				break;		
		}
<span class="nc" id="L155">		System.out.println(&quot;Determined EDHOC message type: &quot; + typeName + &quot;\n&quot;);</span>
		
        // Since the incoming EDHOC message is transported as a CoAP request,
		// it is prepended by C_X, which does not have to be printed
<span class="nc" id="L159">		List&lt;CBORObject&gt; trimmedSequence = new ArrayList&lt;CBORObject&gt;();</span>
<span class="nc" id="L160">		CBORObject[] objectListRequest = CBORObject.DecodeSequenceFromBytes(message);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">		for (int i = 1; i &lt; objectListRequest.length; i++) {</span>
<span class="nc" id="L162">			trimmedSequence.add(objectListRequest[i]);</span>
		}
<span class="nc" id="L164">		byte[] messageToPrint = Util.buildCBORSequence(trimmedSequence);</span>
<span class="nc" id="L165">		Util.nicePrint(typeName, messageToPrint);</span>

		
		/* Start handling EDHOC Message 1 */
		
<span class="nc bnc" id="L170" title="All 2 branches missed.">		if (messageType == Constants.EDHOC_MESSAGE_1) {</span>
			
<span class="nc" id="L172">			processingResult = MessageProcessor.readMessage1(message, true,</span>
<span class="nc" id="L173">															 edhocEndpointInfo.getSupportedCipherSuites(),</span>
															 appProfile);

<span class="nc bnc" id="L176" title="All 4 branches missed.">			if (processingResult.get(0) == null || processingResult.get(0).getType() != CBORType.ByteString) {</span>
<span class="nc" id="L177">				String responseString = new String(&quot;Internal error when processing EDHOC Message 1&quot;);</span>
<span class="nc" id="L178">				System.err.println(responseString);</span>
				
<span class="nc" id="L180">				nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L181">				Response genericErrorResponse = new Response(ResponseCode.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L182">				genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L183">				exchange.respond(genericErrorResponse);</span>
<span class="nc" id="L184">				return;</span>
			}
			
<span class="nc" id="L187">			EdhocSession session = null;</span>
<span class="nc" id="L188">			int responseType = -1;</span>
						
			// A non-zero length response payload would be an EDHOC Error Message
<span class="nc" id="L191">			nextMessage = processingResult.get(0).GetByteString();</span>
			
			// Prepare EDHOC Message 2
<span class="nc bnc" id="L194" title="All 2 branches missed.">			if (nextMessage.length == 0) {</span>
				
				// Deliver EAD_1 to the application, if present
<span class="nc bnc" id="L197" title="All 4 branches missed.">				if (processingResult.size() == 2 &amp;&amp; processingResult.get(1).getType() == CBORType.Array) {</span>
					// This inspected element of 'processing_result' should really be a CBOR Array at this point
<span class="nc" id="L199">					int length = processingResult.get(1).size();</span>
<span class="nc" id="L200">					CBORObject[] ead1 = new CBORObject[length];</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">					for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L202">						ead1[i] = processingResult.get(1).get(i);</span>
					}
<span class="nc" id="L204">					edhocEndpointInfo.getEdp().processEAD1(ead1);</span>
				}
				
<span class="nc" id="L207">				session = MessageProcessor.createSessionAsResponder(message, true,</span>
<span class="nc" id="L208">																	edhocEndpointInfo.getKeyPairs(),</span>
<span class="nc" id="L209">																    edhocEndpointInfo.getIdCreds(),</span>
<span class="nc" id="L210">																    edhocEndpointInfo.getCreds(),</span>
<span class="nc" id="L211">																    edhocEndpointInfo.getSupportedCipherSuites(),</span>
<span class="nc" id="L212">																    edhocEndpointInfo.getUsedConnectionIds(),</span>
<span class="nc" id="L213">																    appProfile, edhocEndpointInfo.getEdp(),</span>
<span class="nc" id="L214">																    edhocEndpointInfo.getOscoreDb());</span>
				
				// Compute the EDHOC Message 2
<span class="nc" id="L217">				nextMessage = MessageProcessor.writeMessage2(session, ead2);</span>

<span class="nc" id="L219">				byte[] connectionIdentifier = session.getConnectionId();</span>
				
				// Deallocate the assigned Connection Identifier for this peer
<span class="nc bnc" id="L222" title="All 4 branches missed.">				if (nextMessage == null || session.getCurrentStep() != Constants.EDHOC_BEFORE_M2) {</span>
<span class="nc" id="L223">					Util.releaseConnectionId(connectionIdentifier, edhocEndpointInfo.getUsedConnectionIds(), session.getOscoreDb());</span>
<span class="nc" id="L224">					session.deleteTemporaryMaterial();</span>
<span class="nc" id="L225">					session = null;</span>
					
<span class="nc" id="L227">					String responseString = new String(&quot;Inconsistent state before sending EDHOC Message 2&quot;);</span>
<span class="nc" id="L228">					System.err.println(responseString);</span>
<span class="nc" id="L229">					nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L230">					Response genericErrorResponse = new Response(ResponseCode.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L231">					genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L232">					exchange.respond(genericErrorResponse);</span>
<span class="nc" id="L233">					return;</span>
				}
				
				// Add the new session to the list of existing EDHOC sessions
<span class="nc" id="L237">				session.setCurrentStep(Constants.EDHOC_AFTER_M2);</span>
<span class="nc" id="L238">				CBORObject connectionIdentifierCbor = CBORObject.FromObject(connectionIdentifier);</span>
<span class="nc" id="L239">				edhocEndpointInfo.getEdhocSessions().put(connectionIdentifierCbor, session);</span>
				
			}
			
<span class="nc" id="L243">			byte[] connectionIdentifier = null;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">			if (session != null) {</span>
<span class="nc" id="L245">				connectionIdentifier = session.getConnectionId();</span>
			}
			
<span class="nc" id="L248">			responseType = MessageProcessor.messageType(nextMessage, false,</span>
<span class="nc" id="L249">														edhocEndpointInfo.getEdhocSessions(), connectionIdentifier);</span>
			
<span class="nc bnc" id="L251" title="All 4 branches missed.">			if (responseType != Constants.EDHOC_MESSAGE_2 &amp;&amp; responseType != Constants.EDHOC_ERROR_MESSAGE) {</span>
<span class="nc" id="L252">				nextMessage = null;</span>
			}
			
<span class="nc bnc" id="L255" title="All 2 branches missed.">			if (nextMessage != null) {</span>
				
<span class="nc" id="L257">				ResponseCode responseCode = ResponseCode.CHANGED;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">				if (responseType == Constants.EDHOC_ERROR_MESSAGE) {</span>
<span class="nc" id="L259">					int responseCodeValue = processingResult.get(1).AsInt32();</span>
<span class="nc" id="L260">					responseCode = ResponseCode.valueOf(responseCodeValue);</span>
					
					// If the Error Message was generated while reading EDHOC Message 1,
					// deliver EAD_1 to the application, if any was present in EDHOC Message 1
<span class="nc bnc" id="L264" title="All 4 branches missed.">					if (processingResult.size() == 3 &amp;&amp; processingResult.get(2).getType() == CBORType.Array) {</span>
					    // This inspected element of 'processing_result' should really be a CBOR Array at this point
<span class="nc" id="L266">					    int length = processingResult.get(2).size();</span>
<span class="nc" id="L267">					    CBORObject[] ead1 = new CBORObject[length];</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">					    for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L269">					        ead1[i] = processingResult.get(2).get(i);</span>
					    }
<span class="nc" id="L271">					    edhocEndpointInfo.getEdp().processEAD1(ead1);</span>
					}
				}

<span class="nc" id="L275">				Response myResponse = new Response(responseCode);</span>
<span class="nc" id="L276">				myResponse.getOptions().setContentFormat(Constants.APPLICATION_EDHOC_CBOR_SEQ);</span>
<span class="nc" id="L277">				myResponse.setPayload(nextMessage);</span>
				
<span class="nc bnc" id="L279" title="All 2 branches missed.">				String myString = (responseType == Constants.EDHOC_MESSAGE_2) ? &quot;EDHOC Message 2&quot; : &quot;EDHOC Error Message&quot;;</span>
<span class="nc" id="L280">				System.out.println(&quot;Response type: &quot; + myString + &quot;\n&quot;);</span>
				
<span class="nc bnc" id="L282" title="All 2 branches missed.">				if (responseType == Constants.EDHOC_MESSAGE_2) {</span>
<span class="nc" id="L283">			        System.out.println(&quot;Sent EDHOC Message 2\n&quot;);</span>
				}
<span class="nc bnc" id="L285" title="All 2 branches missed.">				if (responseType == Constants.EDHOC_ERROR_MESSAGE) {</span>
				    
<span class="nc bnc" id="L287" title="All 2 branches missed.">					if (session != null) {</span>
						// The reading of EDHOC Message 1 was successful, but the writing of EDHOC Message 2 was not
						
						// The session was created, but not added to the list of EDHOC sessions
<span class="nc" id="L291">						Util.releaseConnectionId(session.getConnectionId(),</span>
<span class="nc" id="L292">								                 edhocEndpointInfo.getUsedConnectionIds(),</span>
<span class="nc" id="L293">								                 session.getOscoreDb());</span>
<span class="nc" id="L294">						session.deleteTemporaryMaterial();</span>
<span class="nc" id="L295">						session = null;</span>
					}
					
<span class="nc" id="L298">			        System.out.println(&quot;Sent EDHOC Error Message\n&quot;);</span>
			        if (debugPrint) {
<span class="nc" id="L300">			        	Util.nicePrint(&quot;EDHOC Error Message&quot;, nextMessage);</span>
			        }
				}
				
<span class="nc bnc" id="L304" title="All 2 branches missed.">				if (responseType == Constants.EDHOC_MESSAGE_2) {</span>
<span class="nc" id="L305">					session.setCurrentStep(Constants.EDHOC_SENT_M2);</span>
				}
				
<span class="nc" id="L308">				exchange.respond(myResponse);</span>
<span class="nc" id="L309">				return;</span>
			}
			else {
<span class="nc" id="L312">				Util.purgeSession(session, session.getConnectionId(),</span>
<span class="nc" id="L313">								  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L314">								  edhocEndpointInfo.getUsedConnectionIds());</span>
				
<span class="nc" id="L316">				String responseString = new String(&quot;Inconsistent state after processing EDHOC Message 2&quot;);</span>
<span class="nc" id="L317">				System.err.println(responseString);</span>
<span class="nc" id="L318">				nextMessage = responseString.getBytes(Constants.charset);</span>
<span class="nc" id="L319">				Response genericErrorResponse = new Response(ResponseCode.INTERNAL_SERVER_ERROR);</span>
<span class="nc" id="L320">				genericErrorResponse.setPayload(nextMessage);</span>
<span class="nc" id="L321">				exchange.respond(genericErrorResponse);</span>
				
<span class="nc" id="L323">				return;</span>
			}
			
		}
		/* End handling EDHOC Message 1 */
		
		
		/* Start handling EDHOC Message 2 */
		
<span class="nc bnc" id="L332" title="All 2 branches missed.">		if (messageType == Constants.EDHOC_MESSAGE_2) {</span>
			
<span class="nc" id="L334">			System.out.println(&quot;Handler for processing EDHOC Message 2&quot;);</span>
			
			// Do nothing
			
		}
		
		
		/* Start handling EDHOC Message 3 */
		
<span class="nc bnc" id="L343" title="All 2 branches missed.">		if (messageType == Constants.EDHOC_MESSAGE_3) {</span>
			
<span class="nc" id="L345">			processingResult = MessageProcessor.readMessage3(message, true, null,</span>
<span class="nc" id="L346">															 edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L347">															 edhocEndpointInfo.getPeerPublicKeys(),</span>
<span class="nc" id="L348">															 edhocEndpointInfo.getPeerCredentials(),</span>
<span class="nc" id="L349">															 edhocEndpointInfo.getUsedConnectionIds());</span>
			
<span class="nc bnc" id="L351" title="All 4 branches missed.">			if (processingResult.get(0) == null || processingResult.get(0).getType() != CBORType.ByteString) {</span>
<span class="nc" id="L352">				System.err.println(&quot;Internal error when processing EDHOC Message 3&quot;);</span>
<span class="nc" id="L353">				return;</span>
			}
			
<span class="nc" id="L356">			EdhocSession mySession = null;</span>
			
			// A non-zero length response payload would be an EDHOC Error Message
<span class="nc" id="L359">			nextMessage = processingResult.get(0).GetByteString();</span>
			
			// The EDHOC protocol has successfully completed
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if (nextMessage.length == 0) {</span>
				
				// Deliver EAD_3 to the application, if present
<span class="nc bnc" id="L365" title="All 4 branches missed.">				if (processingResult.size() == 3 &amp;&amp; processingResult.get(2).getType() == CBORType.Array) {</span>
					// Elements of 'processingResult' are:
					//   i) A zero-length CBOR byte string, indicating successful processing;
					//  ii) The Connection Identifier of the Responder, i.e. C_R
					// iii) Optionally, the External Authorization Data EAD_3, as elements of a CBOR array
					
					// This inspected element of 'processingResult' should really be a CBOR Array at this point
<span class="nc" id="L372">					int length = processingResult.get(2).size();</span>
<span class="nc" id="L373">					CBORObject[] ead3 = new CBORObject[length];</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">					for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L375">						ead3[i] = processingResult.get(2).get(i);</span>
					}
<span class="nc" id="L377">					edhocEndpointInfo.getEdp().processEAD3(ead3);</span>
				}
				
<span class="nc" id="L380">				CBORObject cR = processingResult.get(1);</span>
<span class="nc" id="L381">				mySession = edhocEndpointInfo.getEdhocSessions().get(cR);</span>
				
<span class="nc bnc" id="L383" title="All 2 branches missed.">				if (mySession == null) {</span>
<span class="nc" id="L384">					System.err.println(&quot;Inconsistent state before sending EDHOC Message 3&quot;);</span>
<span class="nc" id="L385">					return;</span>
				}
<span class="nc bnc" id="L387" title="All 2 branches missed.">				if (mySession.getCurrentStep() != Constants.EDHOC_AFTER_M3) {</span>
<span class="nc" id="L388">						System.err.println(&quot;Inconsistent state before sending EDHOC Message 3&quot;);							</span>
<span class="nc" id="L389">						Util.purgeSession(mySession, mySession.getConnectionId(),</span>
<span class="nc" id="L390">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L391">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L392">						return;</span>
				}
		        
<span class="nc bnc" id="L395" title="All 2 branches missed.">				if (mySession.getApplicationProfile().getUsedForOSCORE() == true) {</span>
			        /* Invoke the EDHOC-Exporter to produce OSCORE input material */
<span class="nc" id="L397">			        byte[] masterSecret = EdhocSession.getMasterSecretOSCORE(mySession);</span>
<span class="nc" id="L398">			        byte[] masterSalt = EdhocSession.getMasterSaltOSCORE(mySession);</span>
			        if (debugPrint) {
<span class="nc" id="L400">			        	Util.nicePrint(&quot;OSCORE Master Secret&quot;, masterSecret);</span>
<span class="nc" id="L401">			        	Util.nicePrint(&quot;OSCORE Master Salt&quot;, masterSalt);</span>
			        }
			        
			        /* Setup the OSCORE Security Context */
			        
			        // The Sender ID of this peer is the EDHOC connection identifier of the other peer
<span class="nc" id="L407">			        byte[] senderId = mySession.getPeerConnectionId();</span>
			        
			        // The Recipient ID of this peer is the EDHOC connection identifier of this peer
<span class="nc" id="L410">			        byte[] recipientId = mySession.getConnectionId();</span>
			        
<span class="nc bnc" id="L412" title="All 2 branches missed.">			        if (Arrays.equals(senderId, recipientId)) {</span>
<span class="nc" id="L413">						System.err.println(&quot;Error: the Sender ID coincides with the Recipient ID &quot; +</span>
<span class="nc" id="L414">											Utils.toHexString(senderId));</span>
<span class="nc" id="L415">						Util.purgeSession(mySession, mySession.getConnectionId(),</span>
<span class="nc" id="L416">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L417">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L418">						return;</span>
			        }
			        
<span class="nc" id="L421">			        int selectedCipherSuite = mySession.getSelectedCipherSuite();</span>
<span class="nc" id="L422">			        AlgorithmID alg = EdhocSession.getAppAEAD(selectedCipherSuite);</span>
<span class="nc" id="L423">			        AlgorithmID hkdf = EdhocSession.getAppHkdf(selectedCipherSuite);</span>
			        
<span class="nc" id="L425">			        OSCoreCtx ctx = null;</span>
			        try {
<span class="nc" id="L427">						ctx = new OSCoreCtx(masterSecret, false, alg, senderId, </span>
<span class="nc" id="L428">											recipientId, hkdf, edhocEndpointInfo.getOscoreReplayWindow(),</span>
<span class="nc" id="L429">											masterSalt, null, edhocEndpointInfo.getOscoreMaxUnfragmentedSize());</span>
						
<span class="nc" id="L431">					} catch (OSException e) {</span>
<span class="nc" id="L432">						System.err.println(&quot;Error when deriving the OSCORE Security Context &quot; + e.getMessage());						</span>
<span class="nc" id="L433">						Util.purgeSession(mySession, mySession.getConnectionId(),</span>
<span class="nc" id="L434">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L435">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L436">						return;</span>
<span class="nc" id="L437">					}</span>
			        
			        try {
<span class="nc" id="L440">			        	edhocEndpointInfo.getOscoreDb().addContext(edhocEndpointInfo.getUri(), ctx);</span>
<span class="nc" id="L441">					} catch (OSException e) {</span>
<span class="nc" id="L442">						System.err.println(&quot;Error when adding the OSCORE Security Context to the context database &quot; + e.getMessage());							</span>
<span class="nc" id="L443">						Util.purgeSession(mySession, mySession.getConnectionId(),</span>
<span class="nc" id="L444">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L445">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L446">						return;</span>
<span class="nc" id="L447">					}</span>
		        
				}
		        
		        // Prepare the response to send back
<span class="nc" id="L452">		        Response myResponse = new Response(ResponseCode.CHANGED);</span>
		        
<span class="nc bnc" id="L454" title="All 2 branches missed.">		        if (mySession.getApplicationProfile().getUseMessage4() == false) {</span>
			        // Just send an empty response back
		        	
<span class="nc" id="L457">					myResponse.setPayload(nextMessage);</span>
<span class="nc" id="L458">					exchange.respond(myResponse);</span>
<span class="nc" id="L459">					return;</span>
					
			        /*
			        // Alternative sending an empty ACK instead
			        if (exchange.advanced().getRequest().isConfirmable())
			        	exchange.accept();
			        */
					
		        }
		        else {
		        	// message_4 has to be sent to the Initiator
		        	
		        	// Possibly specify external authorization data for EAD_4, or null if none has to be provided
		        	// The EAD is structured in pairs of CBOR items (int, any), i.e. the data type first and then the actual data
<span class="nc" id="L473">					CBORObject[] ead4 = null;</span>
		        	
					// Compute the EDHOC Message 4
<span class="nc" id="L476">					byte[] connectionIdentifierResponder = mySession.getConnectionId();</span>
<span class="nc" id="L477">					nextMessage = MessageProcessor.writeMessage4(mySession, ead4);</span>
					
					// Deallocate the assigned Connection Identifier for this peer
<span class="nc bnc" id="L480" title="All 4 branches missed.">					if (nextMessage == null || mySession.getCurrentStep() != Constants.EDHOC_AFTER_M4) {</span>
<span class="nc" id="L481">						System.err.println(&quot;Inconsistent state before sending EDHOC Message 4&quot;);</span>
<span class="nc" id="L482">						Util.purgeSession(mySession, connectionIdentifierResponder,</span>
<span class="nc" id="L483">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L484">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L485">						return;</span>
					}
					
<span class="nc" id="L488">					int responseType = MessageProcessor.messageType(nextMessage, false,</span>
<span class="nc" id="L489">																	edhocEndpointInfo.getEdhocSessions(),</span>
																	connectionIdentifierResponder);

<span class="nc bnc" id="L492" title="All 4 branches missed.">					if (responseType == Constants.EDHOC_MESSAGE_4 || responseType == Constants.EDHOC_ERROR_MESSAGE) {</span>
						
<span class="nc" id="L494">						myResponse.getOptions().setContentFormat(Constants.APPLICATION_EDHOC_CBOR_SEQ);</span>
<span class="nc" id="L495">						myResponse.setConfirmable(true);</span>
<span class="nc" id="L496">						myResponse.setPayload(nextMessage);</span>
						
<span class="nc bnc" id="L498" title="All 2 branches missed.">						String myString = (responseType == Constants.EDHOC_MESSAGE_4) ?</span>
<span class="nc" id="L499">								                             &quot;EDHOC Message 4&quot; : &quot;EDHOC Error Message&quot;;</span>
<span class="nc" id="L500">						System.out.println(&quot;Response type: &quot; + myString + &quot;\n&quot;);</span>
						
<span class="nc bnc" id="L502" title="All 2 branches missed.">						if (responseType == Constants.EDHOC_MESSAGE_4) {</span>

<span class="nc" id="L504">					        mySession.setCurrentStep(Constants.EDHOC_SENT_M4);</span>
<span class="nc" id="L505">							exchange.respond(myResponse);</span>
					        
<span class="nc" id="L507">					        System.out.println(&quot;Sent EDHOC Message 4\n&quot;);</span>
					        
						}
						
<span class="nc bnc" id="L511" title="All 2 branches missed.">						if (responseType == Constants.EDHOC_ERROR_MESSAGE) {</span>
					        
<span class="nc" id="L513">							int responseCodeValue = processingResult.get(1).AsInt32();</span>
<span class="nc" id="L514">							ResponseCode responseCode = ResponseCode.valueOf(responseCodeValue);</span>
<span class="nc" id="L515">					        sendErrorMessage(exchange, nextMessage, appProfile, responseCode);</span>
					        
<span class="nc" id="L517">					        Util.purgeSession(mySession, connectionIdentifierResponder,</span>
<span class="nc" id="L518">							        		  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L519">							        		  edhocEndpointInfo.getUsedConnectionIds());</span>
					        
<span class="nc" id="L521">					        System.out.println(&quot;Sent EDHOC Error Message\n&quot;);</span>
					        if (debugPrint) {
<span class="nc" id="L523">					        	Util.nicePrint(&quot;EDHOC Error Message&quot;, nextMessage);</span>
					        }
					        
						}
<span class="nc" id="L527">						return;</span>
					}
					else {
<span class="nc" id="L530">						System.err.println(&quot;Inconsistent state before sending EDHOC Message 4&quot;);</span>
<span class="nc" id="L531">						Util.purgeSession(mySession, connectionIdentifierResponder,</span>
<span class="nc" id="L532">										  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L533">										  edhocEndpointInfo.getUsedConnectionIds());</span>
<span class="nc" id="L534">						return;</span>
					}
					
				}
					
			}
			// An EDHOC error message has to be returned in response to EDHOC message_3
			// The session has been possibly purged while attempting to process message_3
			else {
				
				// An Error Message was generated while reading EDHOC Message 3. Hence,
				// deliver EAD_3 to the application, if any was present in EDHOC Message 3
<span class="nc bnc" id="L546" title="All 4 branches missed.">				if (processingResult.size() == 3 &amp;&amp; processingResult.get(2).getType() == CBORType.Array) {</span>
				    // This inspected element of 'processing_result' should really be a CBOR Array at this point
<span class="nc" id="L548">				    int length = processingResult.get(2).size();</span>
<span class="nc" id="L549">				    CBORObject[] ead3 = new CBORObject[length];</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">				    for (int i = 0; i &lt; length; i++) {</span>
<span class="nc" id="L551">				        ead3[i] = processingResult.get(2).get(i);</span>
				    }
<span class="nc" id="L553">				    edhocEndpointInfo.getEdp().processEAD3(ead3);</span>
				}
				
<span class="nc" id="L556">				int responseCodeValue = processingResult.get(1).AsInt32();</span>
<span class="nc" id="L557">				ResponseCode responseCode = ResponseCode.valueOf(responseCodeValue);</span>
<span class="nc" id="L558">				sendErrorMessage(exchange, nextMessage, appProfile, responseCode);</span>
			}
			
<span class="nc" id="L561">			return;</span>
			
		}
		
		
		/* Start handling EDHOC Error Message */
<span class="nc bnc" id="L567" title="All 2 branches missed.">		if (messageType == Constants.EDHOC_ERROR_MESSAGE) {</span>
            
<span class="nc" id="L569">        	CBORObject[] objectList = MessageProcessor.readErrorMessage(message, null,</span>
<span class="nc" id="L570">        			                                                    edhocEndpointInfo.getEdhocSessions());</span>
        	
<span class="nc bnc" id="L572" title="All 2 branches missed.">        	if (objectList != null) {</span>
        	
	        	// The first element is always C_X.
<span class="nc" id="L575">	        	CBORObject cX = objectList[0];</span>
<span class="nc" id="L576">	        	byte[] connectionIdentifier = MessageProcessor.decodeIdentifier(cX);</span>
	        	
<span class="nc bnc" id="L578" title="All 2 branches missed.">	    		if (connectionIdentifier == null) {</span>
<span class="nc" id="L579">	    			System.err.println(&quot;Malformed or invalid connection identifier in EDHOC Error Message&quot;);</span>
<span class="nc" id="L580">	    			return;</span>
	    		}
	        	
	        	// Retrieve ERR_CODE
<span class="nc" id="L584">	        	int errorCode = objectList[1].AsInt32();</span>
<span class="nc" id="L585">	        	System.out.println(&quot;ERR_CODE: &quot; + errorCode + &quot;\n&quot;);</span>
	        	
	        	// Retrieve ERR_INFO
<span class="nc bnc" id="L588" title="All 2 branches missed.">	    		if (errorCode == Constants.ERR_CODE_SUCCESS) {</span>
<span class="nc" id="L589">	    			System.out.println(&quot;Success\n&quot;);</span>
	    		}
<span class="nc bnc" id="L591" title="All 2 branches missed.">	    		else if (errorCode == Constants.ERR_CODE_UNSPECIFIED_ERROR) {</span>
<span class="nc" id="L592">		        	String errMsg = objectList[2].toString();</span>
<span class="nc" id="L593">		        	System.out.println(&quot;ERR_INFO: &quot; + errMsg + &quot;\n&quot;);</span>
<span class="nc" id="L594">	    		}</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">	    		else if (errorCode == Constants.ERR_CODE_WRONG_SELECTED_CIPHER_SUITE) {</span>
<span class="nc" id="L596">	    			CBORObject suitesR = objectList[2];</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">					if (suitesR.getType() == CBORType.Integer) {</span>
<span class="nc" id="L598">			        	System.out.println(&quot;SUITES_R: &quot; + suitesR.AsInt32() + &quot;\n&quot;);</span>
					}
<span class="nc bnc" id="L600" title="All 2 branches missed.">					else if (suitesR.getType() == CBORType.Array) {</span>
<span class="nc" id="L601">						System.out.print(&quot;SUITES_R: [ &quot; );</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">						for (int i = 0; i &lt; suitesR.size(); i++) {</span>
<span class="nc" id="L603">							System.out.print(suitesR.get(i).AsInt32() + &quot; &quot; );</span>
						}
<span class="nc" id="L605">						System.out.println(&quot;]\n&quot;);</span>
					}
	    		}
	        	
	        	// The following simply deletes the EDHOC session. However, if the server was the Initiator 
	        	// and the EDHOC Error Message is a reply to an EDHOC Message 1, it would be fine to prepare a new
	        	// EDHOC Message 1 right away, keeping the same Connection Identifier C_I and this same session.
	        	// In fact, the session is marked as &quot;used&quot;, hence new ephemeral keys would be generated when
	        	// preparing a new EDHOC Message 1. 
	        	
<span class="nc" id="L615">	    		CBORObject connectionIdentifierCbor = CBORObject.FromObject(connectionIdentifier);</span>
<span class="nc" id="L616">	        	EdhocSession mySession = edhocEndpointInfo.getEdhocSessions().get(connectionIdentifierCbor);</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">	    		if (mySession == null) {</span>
<span class="nc" id="L618">	    			System.err.println(&quot;EDHOC session to delete not found&quot;);</span>
<span class="nc" id="L619">	    			return;</span>
	    		}
	    		
<span class="nc" id="L622">	        	Util.purgeSession(mySession, connectionIdentifier,</span>
<span class="nc" id="L623">	        					  edhocEndpointInfo.getEdhocSessions(),</span>
<span class="nc" id="L624">	        					  edhocEndpointInfo.getUsedConnectionIds());</span>
	        	
	        	// If the request is confirmable, send an empty ack
<span class="nc bnc" id="L627" title="All 2 branches missed.">		        if (exchange.advanced().getRequest().isConfirmable())</span>
<span class="nc" id="L628">		        	exchange.accept();</span>
        	
			}
        	
<span class="nc" id="L632">    		return;</span>
			
		}
		

<span class="nc" id="L637">	}</span>
	
	private void sendErrorMessage(CoapExchange exchange, byte[] nextMessage,
			                      AppProfile appProfile, ResponseCode responseCode) {
		
<span class="nc" id="L642">		int responseType = MessageProcessor.messageType(nextMessage, false, edhocEndpointInfo.getEdhocSessions(), null);</span>
		
<span class="nc bnc" id="L644" title="All 2 branches missed.">		if (responseType != Constants.EDHOC_ERROR_MESSAGE) {</span>
<span class="nc" id="L645">			System.err.println(&quot;Inconsistent state before sending EDHOC Error Message&quot;);	</span>
<span class="nc" id="L646">			return;</span>
		}
		
<span class="nc" id="L649">		Response myResponse = new Response(responseCode);</span>
<span class="nc" id="L650">		myResponse.getOptions().setContentFormat(Constants.APPLICATION_EDHOC_CBOR_SEQ);</span>
<span class="nc" id="L651">		myResponse.setPayload(nextMessage);</span>
		
<span class="nc" id="L653">		exchange.respond(myResponse);</span>
		
<span class="nc" id="L655">	}</span>
	
	/*
	 * Process a &quot;trigger request&quot; targeting the EDHOC resource
	 */
	private void processTriggerRequest(CoapExchange request, AppProfile appProfile) {
		// Do nothing
<span class="nc" id="L662">		System.out.println(&quot;Entered processTriggerRequest()&quot;);</span>
		
		// Here the server can start acting as Initiator and send an EDHOC Message 1 as a CoAP response
<span class="nc" id="L665">	}</span>
	
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>